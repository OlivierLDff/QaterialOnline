<html>
<body onload="init()" style="margin: 0;">
    <div id="qml-div" style="height: 100%; width: 100%;">
        <figure style="overflow:visible;" id="qtspinner">
            <center style="margin-top:1.5em;">
                <img id="webasm_load_image" ;
                    style="max-height: 400px; object-fit: contain; display: block; margin-left: auto; margin-right: auto;">
                </img>
                <strong>Qt for WebAssembly: qmlonline</strong>
                <div id="qtstatus"></div>
                <noscript>JavaScript is disabled. Please enable JavaScript to use this application.</noscript>
            </center>
        </figure>
        <canvas id="qtcanvas" oncontextmenu="event.preventDefault()" contenteditable="true"
            style="height: 100%; width: 100%;"></canvas>
    </div>

    <script type="text/javascript" src="qtloader.js"></script>
    <script type='text/javascript'>
        var config;

        const defaultConfig = {
            qmlMessage: function (msg) {
                console.log(`qml: ${msg}`)
                config && config.qmlMessage && config.qmlMessage(msg)
            },
            qmlError: function (error) {
                console.log(`qml error: ${JSON.stringify(error)}`)
                config && config.qmlError && config.qmlError(error)
            },
            posInit: function () {
                config && config.posInit && config.posInit()
            },
        };

        function registerCall(userConfig) {
            config = userConfig
        }

        function init() {
            var qtLoader;

            var spinner = document.querySelector('#qtspinner');
            var canvas = document.querySelector('#qtcanvas');
            var status = document.querySelector('#qtstatus')

            qtLoader = QtLoader({
                canvasElements: [canvas],
                showLoader: function (loaderStatus) {
                    spinner.style.display = 'block';
                    canvas.style.display = 'none';
                    status.innerHTML = loaderStatus + "...";
                },
                showError: function (errorText) {
                    status.innerHTML = errorText;
                    spinner.style.display = 'block';
                    canvas.style.display = 'none';
                },
                showExit: function () {
                    status.innerHTML = "Application exit";
                    if (qtLoader.exitCode !== undefined)
                        status.innerHTML += " with code " + qtLoader.exitCode;
                    if (qtLoader.exitText !== undefined)
                        status.innerHTML += " (" + qtLoader.exitText + ")";
                    spinner.style.display = 'block';
                    canvas.style.display = 'none';
                    console.log("exit", qtLoader.exitCode)
                },
                showCanvas: function () {
                    spinner.style.display = 'none';
                    canvas.style.display = 'block';
                    Module.instantiateWasm = function (imports, successCallback) {
                        console.log('instantiateWasm: instantiating asynchronously');
                    };
                },
            });
            qtLoader.loadEmscriptenModule("qmlonline");

            // TODO: Find a better way to set the initial code and wait for the webassembly to start
            var intervalID = setInterval(
                function () {
                    console.log("Waiting for webassembly to load...")

                    if (Module && !Module.printErr) {
                        Module.printErr = function (text) {
                            // qml message
                            let match = /qml:\ (.*)/.exec(text)
                            if (match) {
                                defaultConfig.qmlMessage(match[1])
                            }

                            //const match = /qrc:\/userItem:(?<line_number>\d+): (?<error_message>.*)/.exec(lines[i])
                            match = /qrc:\/userItem:(\d+): (.*)/.exec(text)

                            if (match) {
                                let line_number = match[1]
                                let error_message = match[2]

                                defaultConfig.qmlError({
                                    row: line_number - 1,
                                    column: 0,
                                    text: error_message,
                                    type: "error"
                                });
                            }

                            //const match = /qrc:\/userItem:(?<line_number>\d+):(?<column_number>\d+): (?<error_message>.*)/
                            match = /qrc:\/userItem:(\d+):(\d+): (.*)/.exec(text)

                            if (match) {
                                let line_number = match[1]
                                let column_number = match[2]
                                let error_message = match[3]

                                defaultConfig.qmlError({
                                    row: line_number - 1,
                                    column: column_number,
                                    text: error_message,
                                    type: "error"
                                });
                            }
                        }
                    }

                    if (Module.self !== undefined) {
                        clearInterval(intervalID);
                        Module.self().setCode(
                            "import QtQuick 2.7; \
import QtQuick.Controls 2.3; \
Rectangle { \
    color: 'red'; \
    anchors.fill: parent; \
    Text { \
        text: 'WEEEEEEEEEE'; \
        font.pixelSize: 50; \
        color: 'white'; \
        anchors.centerIn: parent; \
        RotationAnimator on rotation { \
            running: true; \
            loops: Animation.Infinite; \
            from: 0; \
            to: 360; \
            duration: 1500; \
        } \
    } \
}")
                    }
                    defaultConfig.posInit()
                },
                100);
        }

        function setCode(code) {
            Module && Module.self && Module.self().setCode(code)
        }

        function buildInfo() {
            if (Module && Module.Version) {
                return new Module.Version()
            }
            return undefined
        }

        (function () {
            var images = [
                "https://community.kde.org/images.community/thumb/4/40/Mascot_konqi.png/360px-Mascot_konqi.png",
                "https://community.kde.org/images.community/thumb/c/ce/Mascot_konqi-dev-kde.png/424px-Mascot_konqi-dev-kde.png",
                "https://community.kde.org/images.community/thumb/f/fb/Mascot_konqi-app-dev-katie.png/424px-Mascot_konqi-app-dev-katie.png",
                "https://community.kde.org/images.community/thumb/1/11/Mascot_konqi-dev-qt.png/424px-Mascot_konqi-dev-qt.png",
                "https://community.kde.org/images.community/thumb/5/50/Mascot_konqi-base-framework.png/526px-Mascot_konqi-base-framework.png",
                "https://community.kde.org/images.community/thumb/a/af/Mascot_konqi-base-plasma.png/520px-Mascot_konqi-base-plasma.png",
                "https://community.kde.org/images.community/thumb/7/79/Mascot_konqi-app-dev.png/651px-Mascot_konqi-app-dev.png",
                "https://community.kde.org/images.community/thumb/f/f4/Mascot_konqi-support-document.png/571px-Mascot_konqi-support-document.png",
                "https://community.kde.org/images.community/thumb/9/99/Mascot_konqi-app-hardware.png/424px-Mascot_konqi-app-hardware.png",
            ];
            var img = document.getElementById("webasm_load_image");
            img.src = images[Math.floor(Math.random() * images.length)];
        })();
    </script>
</body>

</html>